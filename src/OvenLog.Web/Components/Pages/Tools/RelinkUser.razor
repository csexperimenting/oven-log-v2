@page "/tools/relink"
@using OvenLog.Domain.Entities
@using OvenLog.Infrastructure.Services
@inject AdminService AdminService
@inject OvenLogService OvenLogService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Oven Log - Relink User</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h2>Relink User</h2>
        <button class="btn" @onclick="GoBack">Back to Tools</button>
    </div>

    <div class="admin-form">
        <p>
            This function is used when a user's login has changed (e.g., due to name change) and there are 
            duplicate user records. It will merge all events from the old user into the new user and 
            create an alias for the old login.
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div class="form-group">
                <label>Old User (to be merged and deleted)</label>
                <select @bind="_oldUserId">
                    <option value="0">-- Select Old User --</option>
                    @foreach (var user in _users)
                    {
                        <option value="@user.Id">@user.FullName (@user.Login)</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>New User (to receive all events)</label>
                <select @bind="_newUserId">
                    <option value="0">-- Select New User --</option>
                    @foreach (var user in _users.Where(u => u.Id != _oldUserId))
                    {
                        <option value="@user.Id">@user.FullName (@user.Login)</option>
                    }
                </select>
            </div>
        </div>

        @if (_oldUserId > 0 && _newUserId > 0)
        {
            var oldUser = _users.FirstOrDefault(u => u.Id == _oldUserId);
            var newUser = _users.FirstOrDefault(u => u.Id == _newUserId);
            <div class="preview-section" style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h4>Preview of Changes:</h4>
                <ul>
                    <li>All events where <strong>@oldUser?.FullName</strong> was the user will be reassigned to <strong>@newUser?.FullName</strong></li>
                    <li>The login "<strong>@oldUser?.Login</strong>" will be added as an alias for <strong>@newUser?.FullName</strong></li>
                    <li>The user record for <strong>@oldUser?.FullName</strong> will be deleted</li>
                </ul>
                <p style="color: #856404;"><strong>Warning:</strong> This action cannot be undone!</p>
            </div>
        }

        <div class="form-actions">
            <button class="btn btn-remove" @onclick="PerformRelink" disabled="@(_oldUserId == 0 || _newUserId == 0 || _isProcessing)">
                @(_isProcessing ? "Processing..." : "Relink Users")
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="@(_isSuccess ? "success-message" : "error-message")" style="margin-top: 15px; padding: 10px; border-radius: 5px; background-color: @(_isSuccess ? "#d4edda" : "#f8d7da");">
                @_message
            </div>
        }
    </div>
</div>

@code {
    private List<User> _users = new();
    private int _oldUserId;
    private int _newUserId;
    private bool _isProcessing;
    private string _message = string.Empty;
    private bool _isSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _users = await OvenLogService.GetAllUsersAsync();
    }

    private async Task PerformRelink()
    {
        if (_oldUserId == 0 || _newUserId == 0 || _oldUserId == _newUserId)
            return;

        _isProcessing = true;
        _message = string.Empty;

        try
        {
            var result = await AdminService.RelinkUserAsync(_oldUserId, _newUserId);
            if (result)
            {
                _isSuccess = true;
                _message = "Users successfully relinked. The old user has been merged into the new user.";
                _oldUserId = 0;
                _newUserId = 0;
                await LoadData();
            }
            else
            {
                _isSuccess = false;
                _message = "Failed to relink users. Please check that both users exist.";
            }
        }
        catch (Exception ex)
        {
            _isSuccess = false;
            _message = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/tools");
    }
}
